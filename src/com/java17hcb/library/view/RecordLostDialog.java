/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.java17hcb.library.view;

import com.java17hcb.library.bus.BusLibraryCard;
import com.java17hcb.library.bus.BusStaff;
import com.java17hcb.library.entity.Book;
import com.java17hcb.library.entity.LibraryCard;
import com.java17hcb.library.entity.Staff_;
import java.awt.Component;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.ArrayList;

import javax.swing.JCheckBox;
import javax.swing.JOptionPane;
import javax.swing.JRadioButton;
import javax.swing.JSpinner;
import javax.swing.SpinnerNumberModel;

/**
 *
 * @author labyr
 */
public class RecordLostDialog extends javax.swing.JDialog {

    private java.awt.Frame parent; 
    private LibraryCard card;
    private List<Book> rentedBooks;      

    
    public RecordLostDialog(java.awt.Frame parent, boolean modal, LibraryCard card) {
        super(parent, modal);
        this.parent = parent;
        this.card = card;
        
        initComponents();
        setupComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btngRentedBooks = new javax.swing.ButtonGroup();
        pnInfo = new javax.swing.JPanel();
        lbReader = new javax.swing.JLabel();
        lbLostedDate = new javax.swing.JLabel();
        tfReader = new javax.swing.JTextField();
        tfLostedDate = new javax.swing.JTextField();
        lbFinesFee = new javax.swing.JLabel();
        snFinesFee = new javax.swing.JSpinner();
        pnRentedBook = new javax.swing.JPanel();
        rbBook1 = new javax.swing.JRadioButton();
        rbBook2 = new javax.swing.JRadioButton();
        rbBook3 = new javax.swing.JRadioButton();
        rbBook4 = new javax.swing.JRadioButton();
        rbBook5 = new javax.swing.JRadioButton();
        btnOK = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        pnInfo.setBorder(javax.swing.BorderFactory.createTitledBorder("Receipt Info"));

        lbReader.setText("Reader");

        lbLostedDate.setText("Losted Date");

        tfReader.setEnabled(false);

        tfLostedDate.setEnabled(false);

        lbFinesFee.setText("Fines Fee");

        javax.swing.GroupLayout pnInfoLayout = new javax.swing.GroupLayout(pnInfo);
        pnInfo.setLayout(pnInfoLayout);
        pnInfoLayout.setHorizontalGroup(
            pnInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnInfoLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(lbReader, javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(lbLostedDate, javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(lbFinesFee, javax.swing.GroupLayout.Alignment.TRAILING))
                .addGap(18, 18, 18)
                .addGroup(pnInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(tfReader, javax.swing.GroupLayout.DEFAULT_SIZE, 200, Short.MAX_VALUE)
                    .addComponent(tfLostedDate)
                    .addGroup(pnInfoLayout.createSequentialGroup()
                        .addComponent(snFinesFee, javax.swing.GroupLayout.PREFERRED_SIZE, 100, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );
        pnInfoLayout.setVerticalGroup(
            pnInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnInfoLayout.createSequentialGroup()
                .addGroup(pnInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lbReader)
                    .addComponent(tfReader, javax.swing.GroupLayout.PREFERRED_SIZE, 24, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(pnInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lbLostedDate)
                    .addComponent(tfLostedDate, javax.swing.GroupLayout.PREFERRED_SIZE, 24, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(18, 18, 18)
                .addGroup(pnInfoLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lbFinesFee)
                    .addComponent(snFinesFee, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(0, 25, Short.MAX_VALUE))
        );

        pnRentedBook.setBorder(javax.swing.BorderFactory.createTitledBorder("Rented Book"));

        btngRentedBooks.add(rbBook1);
        rbBook1.setText("Empty");
        rbBook1.setEnabled(false);

        btngRentedBooks.add(rbBook2);
        rbBook2.setText("Empty");
        rbBook2.setEnabled(false);

        btngRentedBooks.add(rbBook3);
        rbBook3.setText("Empty");
        rbBook3.setEnabled(false);

        btngRentedBooks.add(rbBook4);
        rbBook4.setText("Empty");
        rbBook4.setEnabled(false);

        btngRentedBooks.add(rbBook5);
        rbBook5.setText("Empty");
        rbBook5.setEnabled(false);

        javax.swing.GroupLayout pnRentedBookLayout = new javax.swing.GroupLayout(pnRentedBook);
        pnRentedBook.setLayout(pnRentedBookLayout);
        pnRentedBookLayout.setHorizontalGroup(
            pnRentedBookLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnRentedBookLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(pnRentedBookLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(rbBook1)
                    .addComponent(rbBook2)
                    .addComponent(rbBook3)
                    .addComponent(rbBook4)
                    .addComponent(rbBook5))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        pnRentedBookLayout.setVerticalGroup(
            pnRentedBookLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(pnRentedBookLayout.createSequentialGroup()
                .addComponent(rbBook1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(rbBook2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(rbBook3)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(rbBook4)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(rbBook5)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        btnOK.setText("OK");
        btnOK.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnOKActionPerformed(evt);
            }
        });

        btnCancel.setText("Cancel");
        btnCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(pnInfo, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(pnRentedBook, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGap(0, 152, Short.MAX_VALUE)
                        .addComponent(btnCancel)
                        .addGap(18, 18, 18)
                        .addComponent(btnOK)))
                .addContainerGap())
        );

        layout.linkSize(javax.swing.SwingConstants.HORIZONTAL, new java.awt.Component[] {btnCancel, btnOK});

        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(pnInfo, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(pnRentedBook, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnOK)
                    .addComponent(btnCancel))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnOKActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnOKActionPerformed
        Book selectedBook = null;
        
        // Get selected book
        int chkbPos = 0;
        for(Component c : pnRentedBook.getComponents()){
            if (c instanceof JRadioButton){
                JRadioButton rb = (JRadioButton)c;
                if(rb.isSelected()){
                    selectedBook = rentedBooks.get(chkbPos);
                }
                chkbPos++;
            }
        }
        
        // Check if user select any book
        if(selectedBook == null){
            JOptionPane.showMessageDialog(this, 
                        "Please choose book before commit.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
            
            return;
        }
        
        // Create lost record based on card & selected book        
        long price = (Integer)snFinesFee.getValue();
        int status = BusStaff.getInstance().recordLostBook(card.getId(), selectedBook.getId(), price);
        switch(status){
            case BusStaff.CURRENT_STAFF_DONT_HAVE_PERMISSION:
                JOptionPane.showMessageDialog(this, 
                        "Current staff don't have permission.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                break;
            case BusStaff.RECORD_LOST_BOOK_NOT_EXIST:
                JOptionPane.showMessageDialog(this, 
                        "This book not exist.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                break;
            case BusStaff.RECORD_LOST_LIBRARY_CARD_NOT_EXIST:
                JOptionPane.showMessageDialog(this, 
                        "This library card not exist.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                break;
            case BusStaff.RECORD_LOST_LIBRARY_CARD_NOT_RENT_THIS_BOOK:
                JOptionPane.showMessageDialog(this, 
                        "This library card not rent " + selectedBook.getTitle() + " book.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                break;
            case BusStaff.RECORD_LOST_BOOK_PRICE_LOWER_THAN_FINES_FEE:
                JOptionPane.showMessageDialog(this, 
                        "This book price lower than fines fee",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                SpinnerNumberModel numberModel = new SpinnerNumberModel(5_000,5_000,10_000_000, 5_000);
                snFinesFee.setModel(numberModel);
                snFinesFee.setEditor(new JSpinner.NumberEditor(snFinesFee, "#,###"));
                return;
            case BusStaff.RECORD_LOST_UNKNOWN_ERROR:
                JOptionPane.showMessageDialog(this, 
                        "Unknown.",
                        "Error",
                        JOptionPane.ERROR_MESSAGE);
                break;
            case BusStaff.RECORD_LOST_SUCCESS:
                JOptionPane.showMessageDialog(this, 
                        "Create new lost record for reader " + card.getFullName() + " success!",
                        "Success",
                        JOptionPane.INFORMATION_MESSAGE);
        }
        
        ((MainFrame)parent).setupCardTable();
        dispose();
    }//GEN-LAST:event_btnOKActionPerformed

    private void btnCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelActionPerformed
        dispose();
    }//GEN-LAST:event_btnCancelActionPerformed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btnOK;
    private javax.swing.ButtonGroup btngRentedBooks;
    private javax.swing.JLabel lbFinesFee;
    private javax.swing.JLabel lbLostedDate;
    private javax.swing.JLabel lbReader;
    private javax.swing.JPanel pnInfo;
    private javax.swing.JPanel pnRentedBook;
    private javax.swing.JRadioButton rbBook1;
    private javax.swing.JRadioButton rbBook2;
    private javax.swing.JRadioButton rbBook3;
    private javax.swing.JRadioButton rbBook4;
    private javax.swing.JRadioButton rbBook5;
    private javax.swing.JSpinner snFinesFee;
    private javax.swing.JTextField tfLostedDate;
    private javax.swing.JTextField tfReader;
    // End of variables declaration//GEN-END:variables

    private void setupComponents() {
        setTitle("Create Lost Record");
        setLocationRelativeTo(null);
        
        // Set reader's name
        tfReader.setText(card.getFullName());
        
        // Set rent date
        Date lostedDate = new Date();
        SimpleDateFormat dateFormat = new SimpleDateFormat("dd/mm/yyyy");
        tfLostedDate.setText(dateFormat.format(lostedDate));
        
        // Set spinner fine fee model
        SpinnerNumberModel numberModel = new SpinnerNumberModel(5_000,5_000,10_000_000, 5_000);
        snFinesFee.setModel(numberModel);
        snFinesFee.setEditor(new JSpinner.NumberEditor(snFinesFee, "#,###"));
             
        // Set text for checkbox
        int enabledRadioButton = 0;   
        rentedBooks = BusLibraryCard.getInstance().getRentedBook(card.getId());
        for(Component c : pnRentedBook.getComponents()){
            if (c instanceof JRadioButton && enabledRadioButton < rentedBooks.size()){
                JRadioButton rb = (JRadioButton)c;
                rb.setEnabled(true);
                rb.setText(rentedBooks.get(enabledRadioButton).getTitle() + " - " +
                        rentedBooks.get(enabledRadioButton).getPrice());
                
                enabledRadioButton++;
            }
        }
    }
}
